# Анализ сервисов
Репозиторий посвещен практике в вузе по детекции трафика раличных сервисов. Для этого пишется правило для NGWF в формате JSON.

# Программное обеспечение
Программное обеспечение, используемое в анализе:
- Docker
- tcpdump
- Wireshark
- Burp Suite
- Python

# Стенд
## Анализ
Для анализа трафика понадобится отделять трафик других приложений и трафик браузера. Для этого было проанализиорвано несколько решений и выбрано самое подходящее. Решения, которые помогают отделать трафик:
1. Перенарпавление трафика через прокси
2. Перенаправление трафика, на выделенный tun адаптер. 
3. Маркировка трафика по процессу(с помощью правил помечается трафик, пренадлежащий конкретному приложению)
4. Использование виртуальной машины
5. Использование docker контейнера с браузером

Первой была протестирован способ с proxy. Он оказался рабочим, однако позволял проводить ограниченный анализ сети. Нет дампа всего трафика сети. 
Второй был протестирован способ с перенаправлением трафика на отдельный адаптер, данный способ не обеспечивает нужной чистоты трафика в файле дампа. 
Третий способ - маркировка пакетов. Способ обеспечивает ограниченную функциональность и не может работать самостоятельно. 
Далее протестирована возможность с виртуальной машиной. Он оказался рабочим, но в дамп сети попадала активность операционной системы, за счет чего дамп сети получался не чистым. 
Финальный протестированный способ был с запуском docker контейнера с браузером и запись дампа сети внутри контейнера. По итогу сравнения это лучший способ записи чистого дампа, поскольку контейнер имеет в себе мало процессов и не загружает дамп, контейнер имеет свой интерфейс сети, что прозволяет удобно записывать дамп прямо из него. 

## Подготовка стенда

Для каждого сервиса был записан свой сетевой дамп, для этого использовался контейнер `jlesage/firefox` с установленной утилитой `tcpdump`.
Команда запуска в нужной папке проекта(запись производится идентично для каждого сервиса с перезапуском контейнера из соотвествуюшей директории)

Для начала поднимаем стенд для дампа трафика
```bash
docker run -d --name firefox -e USER_ID=$(id -u) -e GROUP_ID=$(id -g) -p 5800:5800 -p 5900:5900 -v ./dump/:/dump -e SSLKEYLOGFILE=/dump/ssl.log jlesage/firefox
```
Переменная `SSLKEYLOGFILE` используется для дальнейшей расшифровки tls трафика.

Далее устанавливаем утилиты для дампа:

1. Заходим в docker
```bash
docker exec -it firefox sh
```

2. Устанавливаем tcpdump
```bash
apk add tcpdump
```

## Запись

### Wireshark
Начинаем запись
```bash
tcpdump -i eth0 -w /dump/raw.pcap
```
Заканчиваем запись `^C`

### Burp Suite
1. Запускаем Burp и переходим в его браузер.
2. Собираем максимально разнообразные трафик с сайта, для этого тестируем все возможности сайта производим краулинг.
3. Копируем все url из вкладки `Proxy -> HTTP history` в файл `links.txt` в соответсвующей директории.
4. Сохраняем сессию burp для дальнейшего анализа.

# Обработка данных 
1. Открываем `raw.pcap` в Wireshark 
2. Устанавливаем ключ для TLS в Wireshark на `ssl.log`
3. Отделяем трафик сервиса от фонового трафика фильтр для Wireshark `http || tls`(если есть иные особенные протоколы или признаки стоит эти пакеты тоже сохранить, например `http || tls || quic || dns`)
4. Экспортируем эти пакеты в отдельный файл `File -> Export Specified Packets...` сохраняем как `clear.pcap` в соотвествующую диркеторию.
5. Открываем очищенный файл и сохраняем статистику по ip для этого `Statistics -> IPv4 Statistics -> All Addresses` сохраняем в соотвествующую диркеторию в `wireshark_ips.csv`
